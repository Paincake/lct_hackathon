## Описание
Данный репозиторий содержит код бэкенда для хакатона ЛЦТ-Краснодар 2023. Суть задачи: есть задачи с разным приоритетом, временем выполнения и требуемым грейдом сотрудника. Задачи выставляются на разные географические точки Краснодара. Каждый работник имеет офис, из которого выезжает, а также грейд. Необходимо распределить задачи между работниками наиболее эффективным методом.

В данном репозитории находится бэкенд для распределения задач (без самого алгоритма), выдачи данных на фронтенд администратора (приложение на React; информация о статусе задач и редактирование справочников работников и задач) и выдачи данных на мобильное приложение работника (назначенные ему задачи)

## Окружение развёртывания

Бэкенд вместе с базой данных развёрнут на удалённом облаке с помощью Gitlab CI/CD.

Алгоритм распределения реализован на Python и работает в отдельном контейнере. Обмен данными с основным приложением производится в директории /root/volumes:
- Файл workers.txt: записывается основным приложением, содержит в себе данные обо всех работниках
	- {кол-во работников}
	- {id} {уровень грейда} {широта} {долгота}
- Файл tasks.txt: записывается основным приложением, содержит в себе данные обо всех назначенных задачах. Формат файла:
	- {кол-во заданий}
	- {id} {приоритет} {широта} {долгота}
- Файл output.txt: записывается приложением Flask, содержит в себе данные о задачах и работниках, которые должны их выполнять. Формат файла:
	- {N} - кол-во входных наборах, далее в N строках: 
		- {ID_работника} {M}, где M - кол-во задач. Далее в M строках:
			- {ID таска} {широта} {долгота}


## REST API

Коммуникация с бэкендом производится посредством REST API. 
Перед доступом к API необходимо получить токен авторизации следующим запросом:

	POST /login

с параметрами *password* и *username*. 
Данные для менеджера: пароль-manager, логин-manager
Данные для работников: пароль-фамилия на русском с маленькой буквы, логин-фамилия транслитерацией с маленькой буквы

Пример запроса:

	POST http://94.139.254.37:8081/login?password=дерягин&username=deryagin

В ответ вернётся одна строка-UUID токен, который нужно использовать в **каждом запросе** как параметр token.

### Запросы для работника

	GET /tasks
Параметры: 
- UUID token - токен авторизации

Возвращает список назначенных работнику задач.
Формат ответа:

	[
		{
			"empId": 1,
			"note": "",
			"taskName": "name",
			"taskId": 1,
			"taskAssignmentId": 1,
			"priorityName": "name",
			"status": "ASSIGNED",
			"assignmentTimestam": timestamp,
			"onWayTimestamp": timestamp,
			"startTimestamp": timestamp
			"completionTimestamp": timestamp,
			"longitude": 44.444,
			"latitude" : 33.333
		},
	]


	POST /task/{taskAssignmentId}
Параметры: String status, String note, UUID taskAssignmentId, UUID token
- String status: статус задачи (ASSIGNED, ON_WAY, IN_PROGRESS, DONE)
- String note: комментарии при завершении задачи
- UUID taskAssignmentId: ID назначенной задачи
- UUID token: токен авторизации

Изменяет статус назначенной задачи. Соответствующие статусу метки времени выставляются на сервере.


### Запросы для менеджера

	GET /tasks/assign

Параметры:
- UUID token: токен авторизации

Назначает задачи работникам.


	GET /tasks/status

Параметры:
- UUID token: токен авторизации

Формат ответа:

	[
	    {
	        "employee": {
	            "id": 2,
	            "name": "Дерягин Никита Владимирович",
	            "grade": {
	                "id": 1,
	                "gradeLevel": 3,
	                "gradeName": "Синьор"
	            },
	            "address": "ул. Красная, д. 139",
	            "longitude": 38.977047,
	            "latitude": 45.04496
	        },
	        "note": "",
	        "taskName": "Выезд на точку для стимулирования выдач",
	        "priorityName": "Высокий",
	        "status": "ASSIGNED",
	        "assignmentTimestamp": "2023-11-11T12:19:45.645+00:00",
	        "onWayTimestamp": null,
	        "startTimestamp": null,
	        "completionTimestamp": null,
	        "address": "ст-ца. Елизаветинская, ул. Широкая, д. 260"
	    },
	   
	]

Возвращает список назначенных задачи и их статусы.


	GET /business_points

Параметры:
- UUID token-токена авторизации

Формат ответа:
[

    {
        "id": 1,
        "cardsAndMaterialsDelivered": false,
        "addedYesterday": true,
        "daysSinceCardRelease": 0,
        "approvedRequests": 0,
        "releasedCards": 0,
        "address": "ул. Ставропольская, д. 140",
        "longitude": 39.003879,
        "latitude": 45.019844
    },
]

Возвращает информацию по бизнес-точкам. 

	GET /tasks/data

Параметры:
- UUID token-токена авторизации

Формат ответа:
[

    {
        "id": 1,
        "taskPriority": {
            "id": 1,
            "priorityName": "Высокий",
            "priorityLevel": 3
        },
        "taskName": "Выезд на точку для стимулирования выдач",
        "completionTime": 4.0,
        "conditionOne": "Дата выдачи последней карты более 7 дней назад, при этом есть одобренные заявки",
        "conditionTwo": "Дата выдачи последней карты более 14 дней назад",
        "requiredGrades": [
            {
                "id": 1,
                "gradeLevel": 3,
                "gradeName": "Синьор"
            }
        ]
    },
 ]

Возвращает справочную информацию по задачам.


	GET /employees

Параметры:
- UUID token-токена авторизации

Формат ответа:
[
    {

        "id": 2,
        "name": "Дерягин Никита Владимирович",
        "grade": {
            "id": 1,
            "gradeLevel": 3,
            "gradeName": "Синьор"
        },
        "address": "ул. Красная, д. 139",
        "longitude": 38.977047,
        "latitude": 45.04496
    },
 ]

Возвращает справочную информацию по сотрудникам.


	GET /report

Параметры:
- UUID token-токена авторизации

Формат ответа:
[
	
	{
	"employee" : 
		{
        "id": 2,
        "name": "Дерягин Никита Владимирович",
        "grade": {
            "id": 1,
            "gradeLevel": 3,
            "gradeName": "Синьор"
        },
        "address": "ул. Красная, д. 139",
        "longitude": 38.977047,
        "latitude": 45.04496
    },
    "avgRoadTime": 1.3,
    "avgCompletionTime": 1.5,
    "completedTasks": 10
	},
]

Возвращает отчётную информацию по работникам, среднему времени выполнения задачи, среднему времени дороги и кол-ву выполненных задач.


	POST /business_point/add

Параметры:
- UUID token - токен авторизации
Тело запроса:

	{
	    "cardsAndMaterialsDelivered": false,
	    "addedYesterday": true,
	    "daysSinceCardRelease": 0,
	    "approvedRequests": 0,
	    "releasedCards": 0,
	    "address": "ул. Красная, д. 154",
	}

Создаёт новую бизнес-точку. В ответе вернётся информация вместе с координатами и ID в базе данных. Координаты вычисляются по адресу при помощи API Яндекс карт.


	POST /employee/add

Параметры:
- UUID token - токен авторизации
Тело запроса:

	{
    "name": "Николаев Азарий Платонович",
    "grade": {
        "gradeName": "Джун"
    },
    "address": "Краснодар, Красных Партизан, 321"
	}

Создаёт нового работника. В ответе вернётся информация вместе с координатами и ID в базе данных. Координаты вычисляются по адресу при помощи API Яндекс карт.
